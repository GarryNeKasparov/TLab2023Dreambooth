# TLab2023Dreambooth

### DreamBooth: Fine Tuning Text-to-Image Diffusion Models for Subject-Driven Generation
Авторы работы представляют метод для генерации изображений особого объекта на основе небольшого (3-5) числа примеров, данных пользователем. 
Данный метод предоставляет возможность представления объекта в разных позах, местах, стилях; при разных уровнях освещения и т.д.

В основе лежит text-to-image модель, которая обучается воспринимать особый идентификатор как метку требуемого объекта. 
* При обучении пользовательские изображения дополняются текстовыми запросами в формате <i>"A \[идентификатор\] \[класс\]".</i>
* Дополнительно - во избежание переобучения модели под специфический объект <i>(т.е невозможность генерировать что-то из заданного класса, непохожее на идентификатор)</i> - авторы вводят <b>"Class-specific Prior Preservation Loss"</b>: суть в добавлении нового слагаемого при функции ошибки, которое
тем меньше, чем fine-tuning модель генерирует изображения по запросу "A \[класс\]" более "похожими" на сгенерированные изначальной моделью.

В заключение авторы предлагают датасет и правила оценки для выдвинутой задачи "реконтекстуализации" (subject-driven generation), продемонстрированной в работе.

В работе приводятся результаты оценки DreamBooth несколькими метриками (DINO, CLIP-I, CLIP-T), а также сравнение с методом "Textual Inversion". В итоге DreamBooth достиг более высоких значений метрик.

---
Модель добучалось методом LoRA под генерацию моей кошки.
<p align="center">
  <img src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/81dcfdb3-693a-4fae-ac68-b80ed846b574" width="300" height="400">
</p>

Были обучены несколько версий модели:

1) lr=3e-4, steps=1000 
2) lr=1e-6, steps=3000
3) lr=1e-4, steps=2000 с warmup_steps=500

Забегая вперед, модель (2) - недоучилась, генерируя непохожих на мою кошек; модели (1) и (3) справились с задачей, при чем по ощущениям (3) гораздо лучше (картинки менее размыты, кошка более похожа).

В процессе генерации random seed был зафиксирован, где это возможно, поэтому при одинаковых параметрах получался одинаковый результат. Это позволило удобно пробовать разные параметры (интуитивное описание):
* lora scale unet - отвечает за сходство с кошкой: поза, окрас, фон
* lora scale text encoder - обычно почти не влияет на результат, также отвечает за сходство (использовался для тонкой настройки при уже выставленном scale unet)
* guidance - насколько изображение соответствует запросу, при высоких значениях появлялись артефакты, оптимальным я нашел равное 5. Однако при сложных запросах приходилось увеличивать
* перебирая random seed можно было искать лучший результат с данными параметрами и обратно
* влияло также и значение inference steps, иногда при соседних значениях получались совершенно разные картинки

Сравнение модели 1 и 2 (во втором случае lora_scale_unet=0.7, но повышение не улучшало результат - модель неправильно рисовала окрас)
<p align="center">
  <img src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/e633bb86-22b1-4386-bab9-c24d4e707175" width="500" height="400">
  <img src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/9d2e7328-78bc-45e6-b6d4-db815e90145c" width="500" height="400">
</p>


---
Сравнение моделей 1, 2 и 3 
<p align="center">
  <img alt="model 1" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/1b78fbeb-338a-479c-859f-4561ec0a84d2" width="320" height="300">
  <img alt="model 2" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/6702d3ac-db62-4741-bc5e-ed167b8daf33" width="320" height="300">
  <img alt="model 3" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/af79688f-411e-4567-9697-b4bac0d33183" width="320" height="300">
</p>

---
Модель 3 также справилась с переносом стиля
<p align="center">
  <img alt="low scale" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/b3b234e6-4a2e-4ea5-b049-a7306ab97ee5" width="320" height="300">
  <img alt="high scale" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/508a6266-5302-4763-be9f-c7a60cbc5d92" width="320" height="300">
  <img alt="optimal scale" src="https://github.com/GarryNeKasparov/TLab2023Dreambooth/assets/52318064/70ff2d4c-4a06-4836-ab90-5af8629785e4" width="320" height="300">
</p>


---
Не получилось произвести скрещивание с другими животным, как это приведено в работе. Модель воспринимала "cross" как крест/перекрёсток и изображала его. Используя синонимы, перефразирование
удалось сгенерировать что-то подобное, но результат все равно не оправдывал ожиданий (пример, скрещивая бегемота и кошку, получался маленький бегемот с кошачьими глазами). 

Также модель плохо справлялась со сложными запросами по типу "a sks cat playing piano in white fedora" - здесь либо кошка за пианино, либо мужчина в шляпе за пианино, либо кошка в шляпе. Повышением guidance удалось сгенерировать несколько нужных картинок, однако они были крайне зашумлены и невразумительны.

В целом результаты сравнимы с тем, что публикуется другими людьми. Правда, он гораздо хуже, чем в представленной работе по части качества картинки.
